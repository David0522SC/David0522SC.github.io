<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>時光旅程</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ⭐ Lucide Icons UMD 版本（可支援填滿 Fill + Stroke） -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    body {
      background: #0f172a;
      color: white;
    }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
    .animate-fade-in-down { animation: fadeInDown 0.5s ease-out; }

    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px) } to { opacity: 1; transform: translateY(0) } }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px) } to { opacity: 1; transform: translateY(0) } }

    @keyframes heartbeat {
      0% { transform: scale(1); }
      14% { transform: scale(1.15); }
      28% { transform: scale(1); }
      42% { transform: scale(1.15); }
      70% { transform: scale(1); }
    }
    .animate-heartbeat { animation: heartbeat 1.5s ease-in-out infinite both; }
  </style>
</head>

<body class="min-h-screen">
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect, useMemo } = React;

/* -----------------------------------------
   ⭐ Lucide React Wrapper（支援 fill + stroke）
----------------------------------------- */
const Icon = ({ name, className = "" }) => (
  <i data-lucide={name} className={className}></i>
);

const Calendar = (p) => <Icon name="calendar" {...p} />;
const Clock = (p) => <Icon name="clock" {...p} />;
const Heart = (p) => <Icon name="heart" {...p} />;
const Edit2 = (p) => <Icon name="edit-2" {...p} />;
const RotateCcw = (p) => <Icon name="rotate-ccw" {...p} />;
const Info = (p) => <Icon name="info" {...p} />;
const Activity = (p) => <Icon name="activity" {...p} />;
const Users = (p) => <Icon name="users" {...p} />;
const Plus = (p) => <Icon name="plus" {...p} />;
const Trash2 = (p) => <Icon name="trash-2" {...p} />;
const ArrowLeft = (p) => <Icon name="arrow-left" {...p} />;
const ChevronRight = (p) => <Icon name="chevron-right" {...p} />;
const Gift = (p) => <Icon name="gift" {...p} />;
const User = (p) => <Icon name="user" {...p} />;
const Star = (p) => <Icon name="star" {...p} />;
const Sparkles = (p) => <Icon name="sparkles" {...p} />;
const X = (p) => <Icon name="x" {...p} />;
const Check = (p) => <Icon name="check" {...p} />;
const AlertTriangle = (p) => <Icon name="alert-triangle" {...p} />;
const Hourglass = (p) => <Icon name="hourglass" {...p} />;

/* -----------------------------------------
   每次重新 render → 讓 Lucide 轉換 SVG
----------------------------------------- */
const useLucide = () => {
  useEffect(() => {
    if (window.lucide && window.lucide.createIcons) {
      window.lucide.createIcons();
    }
  });
};
/* -----------------------------------------
   載入農曆（不動你的原本寫法）
----------------------------------------- */
const useLunar = () => {
  const [isLoaded, setIsLoaded] = useState(false);

  useEffect(() => {
    if (window.Solar && window.Lunar) {
      setIsLoaded(true);
      return;
    }
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js";
    script.async = true;
    script.onload = () => setIsLoaded(true);
    document.body.appendChild(script);
  }, []);

  return isLoaded;
};

/* -----------------------------------------
   通用確認視窗
----------------------------------------- */
const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
      onClick={onClose}
    >
      <div
        className="bg-[#1e293b] border border-white/10 rounded-3xl p-6 max-w-sm w-full shadow-2xl animate-fade-in-up"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex items-center gap-3 mb-3 text-red-400">
          <div className="p-2 bg-red-500/10 rounded-full">
            <AlertTriangle className="w-6 h-6" />
          </div>
          <h3 className="text-xl font-bold text-white">{title}</h3>
        </div>
        <p className="text-gray-400 mb-6 leading-relaxed">{message}</p>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-3 rounded-xl bg-white/5 text-gray-300 hover:bg-white/10 transition-colors font-medium"
          >
            取消
          </button>

          <button
            onClick={onConfirm}
            className="flex-1 px-4 py-3 rounded-xl bg-gradient-to-r from-red-500 to-rose-600 text-white hover:from-red-600 hover:to-rose-700 shadow-lg shadow-red-500/20 transition-all font-bold"
          >
            確認刪除
          </button>
        </div>
      </div>
    </div>
  );
};

/* -----------------------------------------
   小型數字卡片（保留你的美術風格）
----------------------------------------- */
const NumberCard = ({ value, label, subLabel, highlight = false }) => (
  <div
    className={
      "relative flex flex-col items-center justify-center p-4 rounded-2xl backdrop-blur-md border border-white/10 hover:scale-105 shadow-lg transition-all " +
      (highlight
        ? "bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border-indigo-300/30"
        : "bg-white/5")
    }
  >
    <span
      className={
        "text-4xl md:text-5xl font-mono font-bold tracking-tight " +
        (highlight ? "text-indigo-200" : "text-white")
      }
    >
      {value}
    </span>
    <span className="text-xs md:text-sm text-gray-300 mt-1 uppercase tracking-widest">
      {label}
    </span>
    {subLabel && <span className="text-[10px] text-gray-400">{subLabel}</span>}
  </div>
);

/* -----------------------------------------
   里程碑行（保留你的漸層填充動畫）
----------------------------------------- */
const MilestoneRow = React.memo(({ label, value, unit }) => (
  <div className="group flex justify-between items-center py-5 border-b border-white/5 hover:bg-white/5 px-4 -mx-4 rounded-xl transition-all">
    <span className="text-gray-400 group-hover:text-indigo-200 transition-colors font-medium flex items-center gap-2">
      <Activity className="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity text-indigo-400" />
      {label}
    </span>

    <div className="relative">
      <span className="font-mono text-xl md:text-2xl text-white/20">
        {value} <span className="text-xs md:text-sm font-sans">{unit}</span>
      </span>

      <div className="absolute bottom-0 left-0 w-full h-0 overflow-hidden transition-[height] duration-[2000ms] ease group-hover:h-full">
        <span className="absolute bottom-0 left-0 w-full font-mono text-xl md:text-2xl bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 to-purple-300">
          {value} <span className="text-xs md:text-sm text-indigo-200">{unit}</span>
        </span>
      </div>
    </div>
  </div>
));

/* -----------------------------------------
   時間差計算（你的原本程式完整保留）
----------------------------------------- */
const calculateDetails = (dateStr, timeStr) => {
  const start = new Date(dateStr + "T" + timeStr);
  const now = new Date();
  if (start > now) return null;

  const diff = now - start;
  const totalSeconds = Math.floor(diff / 1000);

  let years = now.getFullYear() - start.getFullYear();
  let months = now.getMonth() - start.getMonth();
  let days = now.getDate() - start.getDate();
  let hours = now.getHours() - start.getHours();
  let minutes = now.getMinutes() - start.getMinutes();
  let seconds = now.getSeconds() - start.getSeconds();

  if (seconds < 0) { seconds += 60; minutes--; }
  if (minutes < 0) { minutes += 60; hours--; }
  if (hours < 0) { hours += 24; days--; }
  if (days < 0) {
    const pm = new Date(now.getFullYear(), now.getMonth(), 0);
    days += pm.getDate();
    months--;
  }
  if (months < 0) { months += 12; years--; }

  return { years, months, days, hours, minutes, seconds, totalSeconds };
};

/* -----------------------------------------
   倒數計算（你的原本邏輯保留）
----------------------------------------- */
const calculateCountdown = (dateStr, timeStr) => {
  const target = new Date(dateStr + "T" + timeStr);
  const now = new Date();
  const diff = target - now;

  const isSameDay =
    target.getFullYear() === now.getFullYear() &&
    target.getMonth() === now.getMonth() &&
    target.getDate() === now.getDate();

  if (diff > 0) {
    const totalSeconds = Math.floor(diff / 1000);
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    let tempDate = new Date(now);
    let Y = target.getFullYear() - tempDate.getFullYear();
    let M = target.getMonth() - tempDate.getMonth();
    let D = target.getDate() - tempDate.getDate();

    if (D < 0) {
      const pm = new Date(target.getFullYear(), target.getMonth(), 0);
      D += pm.getDate();
      M--;
    }
    if (M < 0) { M += 12; Y--; }

    return { status: "future", years: Y, months: M, days: D, hours, minutes, seconds, totalSeconds, totalDays: days };
  }

  if (isSameDay) {
    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
    const sec = Math.floor((end - now) / 1000);

    return {
      status: "today",
      years: 0,
      months: 0,
      days: 0,
      hours: Math.floor(sec / 3600),
      minutes: Math.floor((sec % 3600) / 60),
      seconds: sec % 60,
      totalSeconds: sec
    };
  }

  return { status: "past" };
};

/* -----------------------------------------
   農曆文字
----------------------------------------- */
const getLunarString = (dateStr) => {
  if (!window.Solar) return "載入中...";
  try {
    const d = new Date(dateStr);
    const s = window.Solar.fromYmd(d.getFullYear(), d.getMonth() + 1, d.getDate());
    const l = s.getLunar();
    return `${l.getMonthInChinese()}月${l.getDayInChinese()}`;
  } catch {
    return "";
  }
};

/* -----------------------------------------
   ⭐ DetailTimer（完整可用 Lucide Icons）
----------------------------------------- */
const DetailTimer = ({ profile, onBack, isLoaded }) => {
  useLucide();

  const [now, setNow] = useState(new Date());
  const [stats, setStats] = useState(null);
  const [quoteIndex, setQuoteIndex] = useState(0);

  const quotes = [
    "時間不語，卻回答了所有問題。",
    "每一個不曾起舞的日子，都是對生命的辜負。",
    "逝者如斯夫，不舍晝夜。",
    "既然時間留不住，那就記住它。",
    "當下的每一個瞬間，都是未來的回憶。",
    "歲月極美，在於它必然的流逝。",
    "時間是送給我們最公平的禮物。",
    "往事不回頭，未來不將就。",
    "生命不是要活得長，而是要活得好。",
    "你所浪費的今天，是昨天死去的人奢望的明天。"
  ];

  /* 計時更新 */
  useEffect(() => {
    const t = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(t);
  }, []);

  /* 計算數據 */
  useEffect(() => {
    setStats(
      profile.type === "countdown"
        ? calculateCountdown(profile.date, profile.time)
        : calculateDetails(profile.date, profile.time)
    );
  }, [now, profile]);

  if (!stats) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh]">
        <div className="text-xl text-red-300 font-bold">計算中...</div>
        <button onClick={onBack} className="underline text-gray-400 hover:text-white">
          返回列表
        </button>
      </div>
    );
  }

  /* 倒數已結束 */
  if (profile.type === "countdown" && stats.status === "past") {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] animate-fade-in">
        <div className="p-4 bg-gray-700/50 rounded-full mb-4">
          <Check className="w-12 h-12 text-gray-400" />
        </div>
        <h2 className="text-3xl font-bold">{profile.name}</h2>
        <div className="text-gray-400 text-xl">這個日子已經過去了</div>
        <button onClick={onBack} className="mt-6 px-6 py-2 bg-white/10 rounded-lg hover:bg-white/20">
          返回列表
        </button>
      </div>
    );
  }

  const formatNum = (n) => n.toString().padStart(2, "0");
  /* -----------------------------------------
       DetailTimer（續）
  ----------------------------------------- */

  const themeColor =
    profile.type === "countdown"
      ? "from-sky-500/20 to-blue-500/20 border-sky-300/30"
      : profile.type === "anniversary"
      ? "from-pink-500/20 to-rose-500/20 border-pink-300/30"
      : "from-indigo-500/20 to-purple-500/20 border-indigo-300/30";

  const highlightText =
    profile.type === "countdown"
      ? "text-sky-200"
      : profile.type === "anniversary"
      ? "text-pink-200"
      : "text-indigo-200";

  const CustomNumberCard = ({ value, label, subLabel }) => (
    <div
      className={
        "relative flex flex-col items-center justify-center p-4 rounded-2xl backdrop-blur-md border border-white/10 bg-gradient-to-br " +
        themeColor +
        " shadow-lg hover:scale-105 transition-all"
      }
    >
      <span className={"text-4xl md:text-5xl font-mono font-bold " + highlightText}>
        {value}
      </span>
      <span className="text-xs md:text-sm text-gray-300 mt-1">{label}</span>
      {subLabel && <span className="text-[10px] text-gray-400">{subLabel}</span>}
    </div>
  );

  return (
    <div className="animate-fade-in space-y-10 pb-12">

      {/* 返回按鈕 + 標題區 */}
      <div className="flex items-center justify-between mb-6">
        <button
          onClick={onBack}
          className="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-lg hover:bg-white/10 transition-all"
        >
          <ArrowLeft className="w-4 h-4" />
          返回列表
        </button>

        <div className="text-right">
          <h2 className="text-xl font-bold">{profile.name}</h2>
          <div className="flex justify-end gap-2 text-xs text-gray-400">
            <span>{profile.date}</span>
            {isLoaded && profile.type === "life" && (
              <span className="text-indigo-300">(農 {getLunarString(profile.date)})</span>
            )}
          </div>
        </div>
      </div>

      {/* 主要數字區 */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <NumberCard value={stats.years} label="年" highlight />
        <NumberCard value={stats.months} label="月" />
        <NumberCard value={stats.days} label="天" />
        <NumberCard value={formatNum(stats.hours)} label="小時" />
        <NumberCard value={formatNum(stats.minutes)} label="分鐘" />
        <NumberCard value={formatNum(stats.seconds)} label="秒" subLabel="即時跳動" />
      </div>

      {/* 總秒數 + 愛心動畫 */}
      <div
        className={
          "relative rounded-3xl p-8 shadow-xl border border-white/5 bg-gradient-to-br overflow-hidden " +
          themeColor
        }
      >
        <div className="absolute bottom-2 right-2 w-36 h-36 opacity-20 animate-heartbeat">
          {profile.type === "countdown" ? (
            <Hourglass className="w-full h-full" />
          ) : (
            <Heart className="w-full h-full fill-pink-500 text-pink-500" />
          )}
        </div>

        <h3 className="text-sm text-gray-400">在這個星球上的總秒數</h3>
        <div className="text-4xl md:text-5xl font-mono font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-300 to-teal-300">
          {stats.totalSeconds.toLocaleString()}
          <span className="text-base text-gray-400 ml-2">秒</span>
        </div>
        <p className="text-xs text-gray-500 mt-4">每一秒都是生命的禮物。</p>
      </div>

      {/* 里程碑 */}
      <div className="space-y-4">
        <MilestoneRow
          label="總天數"
          value={Math.floor(stats.totalSeconds / 86400).toLocaleString()}
          unit="天"
        />
        <MilestoneRow
          label="總週數"
          value={Math.floor(stats.totalSeconds / (86400 * 7)).toLocaleString()}
          unit="週"
        />
        <MilestoneRow
          label="總小時"
          value={Math.floor(stats.totalSeconds / 3600).toLocaleString()}
          unit="小時"
        />
      </div>
    </div>
  );
};

/* -----------------------------------------
   ⭐ 主程式 LifeJourney（完整可執行）
----------------------------------------- */
const LifeJourney = () => {
  useLucide();
  const isLoaded = useLunar();

  const [view, setView] = useState("dashboard");
  const [activeTab, setActiveTab] = useState("life");
  const [profiles, setProfiles] = useState(() => {
    const saved = localStorage.getItem("lifeJourneyProfiles");
    return saved ? JSON.parse(saved) : [];
  });
  const [selectedProfileId, setSelectedProfileId] = useState(null);
  const [deleteTargetId, setDeleteTargetId] = useState(null);

  const [formData, setFormData] = useState({
    name: "",
    relation: "",
    date: "",
    time: "00:00",
    type: "life",
  });

  useEffect(() => {
    localStorage.setItem("lifeJourneyProfiles", JSON.stringify(profiles));
  }, [profiles]);

  const addProfile = () => {
    if (!formData.name || !formData.date) return;
    setProfiles([
      ...profiles,
      {
        id: Date.now().toString(),
        ...formData,
      },
    ]);
    setView("dashboard");
  };

  const openDetail = (p) => {
    setSelectedProfileId(p.id);
    setView("detail");
  };

  const selectedProfile = profiles.find((p) => p.id === selectedProfileId);

  /* -----------------------------------------
       Dashboard
  ----------------------------------------- */
  const Dashboard = () => (
    <div className="animate-fade-in">
      <ConfirmModal
        isOpen={!!deleteTargetId}
        onClose={() => setDeleteTargetId(null)}
        onConfirm={() => {
          setProfiles((prev) => prev.filter((p) => p.id !== deleteTargetId));
          setDeleteTargetId(null);
        }}
        title="刪除確認"
        message="刪除後將無法復原。"
      />

      {/* Tabs */}
      <div className="flex p-1 bg-white/5 rounded-2xl mb-6 w-fit mx-auto">
        {[
          ["life", <User className="w-4 h-4" />, "時光足跡"],
          ["anniversary", <Gift className="w-4 h-4" />, "紀念日"],
          ["countdown", <Hourglass className="w-4 h-4" />, "倒數日"],
        ].map(([type, icon, text]) => (
          <button
            key={type}
            onClick={() => setActiveTab(type)}
            className={
              "flex items-center gap-2 px-6 py-2 rounded-xl transition-all " +
              (activeTab === type
                ? "bg-indigo-500 text-white shadow-lg"
                : "text-gray-400 hover:text-white")
            }
          >
            {icon}
            {text}
          </button>
        ))}
      </div>

      {/* Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {profiles
          .filter((p) => p.type === activeTab)
          .map((p) => {
            const stats =
              p.type === "countdown"
                ? calculateCountdown(p.date, p.time)
                : calculateDetails(p.date, p.time);

            return (
              <div
                key={p.id}
                onClick={() => openDetail(p)}
                className="group bg-white/5 p-6 rounded-2xl border border-white/10 hover:bg-white/10 transition-all cursor-pointer"
              >
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-xl font-bold group-hover:text-indigo-200 transition-colors">
                      {p.name}
                    </h3>

                    <div className="text-xs text-gray-400 flex gap-2">
                      <span>{p.date}</span>
                      {isLoaded && p.type === "life" && (
                        <span className="text-indigo-300">
                          農 {getLunarString(p.date)}
                        </span>
                      )}
                    </div>
                  </div>

                  <ChevronRight className="w-5 h-5 text-gray-600 group-hover:translate-x-1 transition-transform" />
                </div>

                <div className="text-3xl font-mono text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300">
                  {stats?.years ?? "--"}
                </div>
                <div className="text-xs text-gray-400 mt-1">年齡 / 經過時間</div>
              </div>
            );
          })}

        {/* New card */}
        <button
          onClick={() => {
            setFormData({ name: "", relation: "", date: "", time: "00:00", type: activeTab });
            setView("form");
          }}
          className="flex flex-col items-center justify-center h-40 border-2 border-dashed border-white/10 rounded-2xl hover:border-indigo-500/50 hover:bg-indigo-500/5 transition-all"
        >
          <Plus className="w-8 h-8 text-gray-400" />
          <span className="text-sm text-gray-400 mt-2">新增</span>
        </button>
      </div>
    </div>
  );

  /* -----------------------------------------
       表單
  ----------------------------------------- */
  const FormView = () => (
    <div className="max-w-md mx-auto bg-white/5 p-8 rounded-3xl border border-white/10 shadow-xl animate-fade-in-up">
      <h2 className="text-lg font-bold mb-6">新增紀錄</h2>

      <div className="space-y-4">
        <input
          className="w-full bg-black/20 border border-white/10 px-4 py-3 rounded-xl"
          placeholder="名稱"
          value={formData.name}
          onChange={(e) =>
            setFormData({ ...formData, name: e.target.value })
          }
        />

        <input
          className="w-full bg-black/20 border border-white/10 px-4 py-3 rounded-xl"
          placeholder="描述 / 關係"
          value={formData.relation}
          onChange={(e) =>
            setFormData({ ...formData, relation: e.target.value })
          }
        />

        <input
          type="date"
          className="w-full bg-black/20 border border-white/10 px-4 py-3 rounded-xl"
          value={formData.date}
          onChange={(e) =>
            setFormData({ ...formData, date: e.target.value })
          }
        />

        <input
          type="time"
          className="w-full bg-black/20 border border-white/10 px-4 py-3 rounded-xl"
          value={formData.time}
          onChange={(e) =>
            setFormData({ ...formData, time: e.target.value })
          }
        />

        <div className="flex gap-3 pt-4">
          <button
            onClick={() => setView("dashboard")}
            className="flex-1 bg-white/10 py-3 rounded-xl hover:bg-white/20"
          >
            返回
          </button>

          <button
            onClick={addProfile}
            className="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 py-3 rounded-xl font-bold"
          >
            儲存
          </button>
        </div>
      </div>
    </div>
  );

  /* -----------------------------------------
       主畫面渲染
  ----------------------------------------- */
  return (
    <div className="container mx-auto px-4 py-8 max-w-5xl">
      {view === "dashboard" && <Dashboard />}
      {view === "form" && <FormView />}
      {view === "detail" && selectedProfile && (
        <DetailTimer
          profile={selectedProfile}
          onBack={() => setView("dashboard")}
          isLoaded={isLoaded}
        />
      )}
    </div>
  );
};

/* -----------------------------------------
   React 渲染
----------------------------------------- */
ReactDOM.createRoot(document.getElementById("root")).render(<LifeJourney />);

</script>
</body>
</html>
